--== referencias ==
local P = game.Players.LocalPlayer
local Plrs = game:GetService("Players")
local RS = game:GetService("RunService")
local UIS = game:GetService("UserInputService")
local TS = game:GetService("TeleportService")
local Camera = workspace.CurrentCamera

--== personaje ==
local C = P.Character or P.CharacterAdded:Wait()
P.CharacterAdded:Connect(function(char) C = char end)

--== GUI principal ==
local G = Instance.new("ScreenGui", P:WaitForChild("PlayerGui"))
G.Name = "ArsenalGui"

local W = Instance.new("Frame", G)
W.Size = UDim2.new(0,360,0,420)
W.Position = UDim2.new(0.5,-180,0.5,-210)
W.BackgroundColor3 = Color3.fromRGB(20,20,20)
W.Active = true

--== barra superior ==
local B = Instance.new("Frame", W)
B.Size = UDim2.new(1,0,0,30)
B.BackgroundColor3 = Color3.fromRGB(40,40,40)

local T = Instance.new("TextLabel", B)
T.Size = UDim2.new(1,-30,1,0)
T.Text = "Arsenal Control"
T.TextColor3 = Color3.new(1,1,1)
T.BackgroundTransparency = 1
T.TextXAlignment = Enum.TextXAlignment.Left
T.TextSize = 16

local CBtn = Instance.new("TextButton", B)
CBtn.Size = UDim2.new(0,30,0,30)
CBtn.Position = UDim2.new(1,-30,0,0)
CBtn.Text = "X"
CBtn.TextScaled = true
CBtn.BackgroundColor3 = Color3.fromRGB(60,60,60)
CBtn.TextColor3 = Color3.new(1,1,1)
CBtn.BorderSizePixel = 0
CBtn.MouseButton1Click:Connect(function() G:Destroy() end)

--== scroll ==
local SF = Instance.new("ScrollingFrame", W)
SF.Size = UDim2.new(1,0,1,-30)
SF.Position = UDim2.new(0,0,0,30)
SF.BackgroundTransparency = 1
SF.ScrollBarThickness = 8
SF.CanvasSize = UDim2.new(0,0,0,1)

local Cn = Instance.new("Frame", SF)
Cn.Size = UDim2.new(1,0,0,600)
Cn.BackgroundTransparency = 1

local function ajustarScroll()
	local h = 0
	for _,v in pairs(Cn:GetChildren()) do
		if v:IsA("GuiObject") then
			local bottom = v.Position.Y.Offset + v.AbsoluteSize.Y
			if bottom > h then h = bottom end
		end
	end
	SF.CanvasSize = UDim2.new(0,0,0,h)
end

--== Carpetas estilo escritorio ==
local function createFolder(title, posY)
	local folder = Instance.new("Frame", Cn)
	folder.Size = UDim2.new(1,-40,0,0)
	folder.Position = UDim2.new(0,20,0,posY)
	folder.BackgroundColor3 = Color3.fromRGB(30,30,30)
	folder.BorderSizePixel = 0
	local lbl = Instance.new("TextLabel", folder)
	lbl.Size = UDim2.new(1,0,0,20)
	lbl.Text = title
	lbl.TextColor3 = Color3.new(1,1,1)
	lbl.BackgroundTransparency = 1
	lbl.TextXAlignment = Enum.TextXAlignment.Left
	lbl.TextSize = 14
	return folder
end

local optionsFolder = createFolder("Opciones", 10)
local keybindFolder = createFolder("Teclas", 160)

--== Opciones ==
local ESP = false
local camFollow = false
local autoRejoin = false
local espObjs = {}

local function isEnemy(plr)
	return plr ~= P and plr.Team ~= P.Team
end

local function applyESP(p)
	if espObjs[p] then return end
	if not p.Character then return end
	local hum = p.Character:FindFirstChild("Humanoid")
	if not hum then return end
	local h = Instance.new("Highlight")
	h.Name = "ESP"
	h.FillTransparency = 1
	h.OutlineColor = isEnemy(p) and Color3.fromRGB(255,0,0) or Color3.fromRGB(0,120,255)
	h.OutlineTransparency = 0
	h.Adornee = p.Character
	h.Parent = p.Character
	espObjs[p] = h
end

local function removeESP(p)
	if espObjs[p] then
		espObjs[p]:Destroy()
		espObjs[p] = nil
	end
end

local function toggleESP(state)
	ESP = state
	for _,plr in pairs(Plrs:GetPlayers()) do
		if ESP then applyESP(plr) else removeESP(plr) end
	end
end

-- Botones de opciones
local ESPBtn = Instance.new("TextButton", optionsFolder)
ESPBtn.Size = UDim2.new(1,0,0,30)
ESPBtn.Position = UDim2.new(0,0,0,30)
ESPBtn.Text = "ESP: OFF"
ESPBtn.BackgroundColor3 = Color3.fromRGB(60,60,60)
ESPBtn.TextColor3 = Color3.new(1,1,1)
ESPBtn.BorderSizePixel = 0
ESPBtn.MouseButton1Click:Connect(function()
	ESP = not ESP
	ESPBtn.Text = ESP and "ESP: ON" or "ESP: OFF"
	toggleESP(ESP)
	ajustarScroll()
end)

local CamBtn = Instance.new("TextButton", optionsFolder)
CamBtn.Size = UDim2.new(1,0,0,30)
CamBtn.Position = UDim2.new(0,0,0,70)
CamBtn.Text = "Camara F1: OFF"
CamBtn.BackgroundColor3 = Color3.fromRGB(60,60,60)
CamBtn.TextColor3 = Color3.new(1,1,1)
CamBtn.BorderSizePixel = 0
CamBtn.MouseButton1Click:Connect(function()
	camFollow = not camFollow
	CamBtn.Text = camFollow and "Camara F1: ON" or "Camara F1: OFF"
end)

local ARBtn = Instance.new("TextButton", optionsFolder)
ARBtn.Size = UDim2.new(1,0,0,30)
ARBtn.Position = UDim2.new(0,0,0,110)
ARBtn.Text = "AutoRejoin: OFF"
ARBtn.BackgroundColor3 = Color3.fromRGB(60,60,60)
ARBtn.TextColor3 = Color3.new(1,1,1)
ARBtn.BorderSizePixel = 0
ARBtn.MouseButton1Click:Connect(function()
	autoRejoin = not autoRejoin
	ARBtn.Text = autoRejoin and "AutoRejoin: ON" or "AutoRejoin: OFF"
	ajustarScroll()
	if autoRejoin then
		task.defer(function()
			task.wait(2)
			pcall(function() TS:Teleport(game.PlaceId,P) end)
		end)
	end
end)

--== Keybinds ==
local Keybinds = {
	CamaraF1 = Enum.KeyCode.R,
	ESP = Enum.KeyCode.T,
}

local function createKeybindUI(labelText, defaultKey, posY)
	local lbl = Instance.new("TextLabel", keybindFolder)
	lbl.Size = UDim2.new(0.5,0,0,20)
	lbl.Position = UDim2.new(0,0,0,posY)
	lbl.Text = labelText
	lbl.TextColor3 = Color3.new(1,1,1)
	lbl.BackgroundTransparency = 1
	lbl.TextXAlignment = Enum.TextXAlignment.Left
	lbl.TextSize = 14

	local box = Instance.new("TextBox", keybindFolder)
	box.Size = UDim2.new(0.4,-10,0,20)
	box.Position = UDim2.new(0.55,0,0,posY)
	box.Text = defaultKey.Name
	box.ClearTextOnFocus = false
	box.TextColor3 = Color3.new(0,0,0)
	box.BackgroundColor3 = Color3.fromRGB(200,200,200)
	box.TextSize = 14
	return box
end

local CamKeyBox = createKeybindUI("Cámara F1:", Keybinds.CamaraF1, 30)
local ESPKeyBox = createKeybindUI("ESP:", Keybinds.ESP, 60)

CamKeyBox.FocusLost:Connect(function()
	local key = CamKeyBox.Text:upper()
	local success, enumKey = pcall(function() return Enum.KeyCode[key] end)
	if success and enumKey then
		Keybinds.CamaraF1 = enumKey
	else
		CamKeyBox.Text = Keybinds.CamaraF1.Name
	end
end)

ESPKeyBox.FocusLost:Connect(function()
	local key = ESPKeyBox.Text:upper()
	local success, enumKey = pcall(function() return Enum.KeyCode[key] end)
	if success and enumKey then
		Keybinds.ESP = enumKey
	else
		ESPKeyBox.Text = Keybinds.ESP.Name
	end
end)

--== Cámara visible ==
local followDistance = 12
local heightOffset = 6
local smoothness = 5
local lastVisiblePos = nil
local occlusionDelay = 0.15
local occlusionTimer = 0

local function esVisible(objetivo)
	if not objetivo or not objetivo.Character then return false end
	local hrp = objetivo.Character:FindFirstChild("HumanoidRootPart")
	if not hrp then return false end
	local targetPos = hrp.Position + Vector3.new(0,2,0)
	local camPos = Camera.CFrame.Position
	local ignoreList = {C, objetivo.Character}
	local parts = workspace.CurrentCamera:GetPartsObscuringTarget({camPos, targetPos}, ignoreList)
	return #parts == 0
end

local function getVisibleEnemy()
	for _,plr in pairs(Plrs:GetPlayers()) do
		if plr ~= P and plr.Team ~= P.Team and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
			local hum = plr.Character:FindFirstChild("Humanoid")
			if hum and hum.Health > 0 and esVisible(plr) then
				return plr
			end
		end
	end
	return nil
end

RS.RenderStepped:Connect(function(dt)
	if camFollow then
		local tgt = getVisibleEnemy()
		if tgt and tgt.Character and tgt.Character:FindFirstChild("HumanoidRootPart") then
			local root = tgt.Character.HumanoidRootPart
			local targetPos = root.Position + Vector3.new(0,2,0)
			local visible = esVisible(tgt)

			if visible then
				lastVisiblePos = root.Position
				occlusionTimer = 0

				local moveDir = root.Velocity.Magnitude > 1 and root.Velocity.Unit or root.CFrame.LookVector
				local desiredPos = root.Position - moveDir * followDistance + Vector3.new(0, heightOffset, 0)
				local newPos = Camera.CFrame.Position:Lerp(desiredPos, dt*smoothness)
				local targetLook = CFrame.new(newPos, targetPos)
				Camera.CFrame = Camera.CFrame:Lerp(targetLook, dt*smoothness)
			else
				occlusionTimer = occlusionTimer + dt
				if occlusionTimer < 0.15 and lastVisiblePos then
					local desiredPos = lastVisiblePos + Vector3.new(0,heightOffset,0) - (root.CFrame.LookVector * followDistance)
					local newPos = Camera.CFrame.Position:Lerp(desiredPos, dt*smoothness)
					local targetLook = CFrame.new(newPos, lastVisiblePos + Vector3.new(0,2,0))
					Camera.CFrame = Camera.CFrame:Lerp(targetLook, dt*smoothness)
				elseif lastVisiblePos then
					local targetLook = CFrame.new(Camera.CFrame.Position, lastVisiblePos + Vector3.new(0,2,0))
					Camera.CFrame = Camera.CFrame:Lerp(targetLook, dt*smoothness)
				end
			end
		end
	end
end)

--== Input global ==
UIS.InputBegan:Connect(function(input, gameProcessed)
	if gameProcessed then return end
	if input.UserInputType == Enum.UserInputType.Keyboard then
		if input.KeyCode == Keybinds.CamaraF1 then
			camFollow = not camFollow
			CamBtn.Text = camFollow and "Camara F1: ON" or "Camara F1: OFF"
		elseif input.KeyCode == Keybinds.ESP then
			ESP = not ESP
			ESPBtn.Text = ESP and "ESP: ON" or "ESP: OFF"
			toggleESP(ESP)
		end
	end
end)

--== Mover ventana ==
local drag, dragStart, startPos = false
B.InputBegan:Connect(function(i)
	if i.UserInputType == Enum.UserInputType.MouseButton1 then
		drag = true
		dragStart = i.Position
		startPos = W.Position
	end
end)
B.InputEnded:Connect(function(i)
	if i.UserInputType == Enum.UserInputType.MouseButton1 then
		drag = false
	end
end)
UIS.InputChanged:Connect(function(i)
	if i.UserInputType == Enum.UserInputType.MouseMovement and drag then
		local d = i.Position - dragStart
		W.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + d.X, startPos.Y.Scale, startPos.Y.Offset + d.Y)
	end
end)

ajustarScroll()
