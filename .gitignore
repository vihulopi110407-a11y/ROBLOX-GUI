--== referencias ==--
local P = game.Players.LocalPlayer
local Plrs = game:GetService("Players")
local RS = game:GetService("RunService")
local UIS = game:GetService("UserInputService")
local TS = game:GetService("TeleportService")
local Camera = workspace.CurrentCamera

--== personaje ==--
local C = P.Character or P.CharacterAdded:Wait()
P.CharacterAdded:Connect(function(char) C = char end)

--== GUI principal ==--
local G = Instance.new("ScreenGui", P:WaitForChild("PlayerGui"))
G.Name = "ArsenalGui"

local W = Instance.new("Frame", G)
W.Size = UDim2.new(0,320,0,340)
W.Position = UDim2.new(0.5,-160,0.5,-170)
W.BackgroundColor3 = Color3.fromRGB(20,20,20)
W.Active = true

--== barra superior ==--
local B = Instance.new("Frame", W)
B.Size = UDim2.new(1,0,0,30)
B.BackgroundColor3 = Color3.fromRGB(40,40,40)

local T = Instance.new("TextLabel", B)
T.Size = UDim2.new(1,-30,1,0)
T.Text = "Arsenal Control"
T.TextColor3 = Color3.new(1,1,1)
T.BackgroundTransparency = 1
T.TextXAlignment = Enum.TextXAlignment.Left
T.TextSize = 16

local CBtn = Instance.new("TextButton", B)
CBtn.Size = UDim2.new(0,30,0,30)
CBtn.Position = UDim2.new(1,-30,0,0)
CBtn.Text = "X"
CBtn.TextScaled = true
CBtn.BackgroundColor3 = Color3.fromRGB(60,60,60)
CBtn.TextColor3 = Color3.new(1,1,1)
CBtn.BorderSizePixel = 0
CBtn.MouseButton1Click:Connect(function() G:Destroy() end)

--== scroll ==--
local SF = Instance.new("ScrollingFrame", W)
SF.Size = UDim2.new(1,0,1,-30)
SF.Position = UDim2.new(0,0,0,30)
SF.BackgroundTransparency = 1
SF.ScrollBarThickness = 8
SF.CanvasSize = UDim2.new(0,0,0,1)

local Cn = Instance.new("Frame", SF)
Cn.Size = UDim2.new(1,0,0,400)
Cn.BackgroundTransparency = 1

local function ajustarScroll()
	local h = 0
	for _,v in pairs(Cn:GetChildren()) do
		if v:IsA("GuiObject") then
			local bottom = v.Position.Y.Offset + v.AbsoluteSize.Y
			if bottom > h then h = bottom end
		end
	end
	SF.CanvasSize = UDim2.new(0,0,0,h)
end

--== ESP ==--
local ESP = false
local espObjs = {}
local function isEnemy(plr)
	return plr ~= P and plr.Team ~= P.Team
end

local function applyESP(p)
	if espObjs[p] then return end
	if not p.Character then return end
	local hum = p.Character:FindFirstChild("Humanoid")
	if not hum then return end
	local h = Instance.new("Highlight")
	h.Name = "ESP"
	h.FillTransparency = 1
	h.OutlineColor = isEnemy(p) and Color3.fromRGB(255,0,0) or Color3.fromRGB(0,120,255)
	h.OutlineTransparency = 0
	h.Adornee = p.Character
	h.Parent = p.Character
	espObjs[p] = h
end

local function removeESP(p)
	if espObjs[p] then
		espObjs[p]:Destroy()
		espObjs[p] = nil
	end
end

local function toggleESP(state)
	ESP = state
	for _,plr in pairs(Plrs:GetPlayers()) do
		if ESP then applyESP(plr) else removeESP(plr) end
	end
end

Plrs.PlayerAdded:Connect(function(plr)
	plr.CharacterAdded:Connect(function()
		if ESP then task.wait(0.5) applyESP(plr) end
	end)
end)

for _,plr in pairs(Plrs:GetPlayers()) do
	plr.CharacterAdded:Connect(function()
		if ESP then task.wait(0.5) applyESP(plr) end
	end)
end

local ESPBtn = Instance.new("TextButton", Cn)
ESPBtn.Size = UDim2.new(1,-40,0,30)
ESPBtn.Position = UDim2.new(0,20,0,10)
ESPBtn.Text = "ESP: OFF"
ESPBtn.BackgroundColor3 = Color3.fromRGB(60,60,60)
ESPBtn.TextColor3 = Color3.new(1,1,1)
ESPBtn.BorderSizePixel = 0
ESPBtn.MouseButton1Click:Connect(function()
	ESP = not ESP
	ESPBtn.Text = ESP and "ESP: ON" or "ESP: OFF"
	toggleESP(ESP)
	ajustarScroll()
end)

--== Cámara F1 usando GetPartsObscuringTarget ==--
local camFollow = false
local camKey = Enum.KeyCode.F
local followDistance = 12
local heightOffset = 6
local smoothness = 5

local lastVisiblePos = nil
local occlusionDelay = 0.15
local occlusionTimer = 0

local CamBtn = Instance.new("TextButton", Cn)
CamBtn.Size = UDim2.new(1,-40,0,30)
CamBtn.Position = UDim2.new(0,20,0,50)
CamBtn.Text = "Camara F1: OFF"
CamBtn.BackgroundColor3 = Color3.fromRGB(60,60,60)
CamBtn.TextColor3 = Color3.new(1,1,1)
CamBtn.BorderSizePixel = 0

CamBtn.MouseButton1Click:Connect(function()
    camFollow = not camFollow
    CamBtn.Text = camFollow and "Camara F1: ON" or "Camara F1: OFF"
end)

UIS.InputBegan:Connect(function(input,gameProcessed)
    if not gameProcessed and input.UserInputType == Enum.UserInputType.Keyboard then
        if input.KeyCode == camKey then
            camFollow = not camFollow
            CamBtn.Text = camFollow and "Camara F1: ON" or "Camara F1: OFF"
        end
    end
end)

local function isOccluded(camPos, targetPos)
    local ignoreList = {}
    -- ignorar personajes para GetPartsObscuringTarget
    table.insert(ignoreList, C)
    local parts = workspace.CurrentCamera:GetPartsObscuringTarget({camPos, targetPos}, ignoreList)
    -- si hay partes *entre* la cámara y el enemigo significa oclusión
    return #parts > 0
end

RS.RenderStepped:Connect(function(dt)
    if camFollow then
        local tgt = getClosestEnemy()
        if tgt and tgt.Character and tgt.Character:FindFirstChild("HumanoidRootPart") then
            local root = tgt.Character.HumanoidRootPart
            local camPos = Camera.CFrame.Position
            local targetPos = root.Position + Vector3.new(0,2,0)

            local occluded = isOccluded(camPos, targetPos)

            if not occluded then
                lastVisiblePos = root.Position
                occlusionTimer = 0

                local moveDir = root.Velocity.Magnitude > 1 and root.Velocity.Unit or root.CFrame.LookVector
                local desiredPos = root.Position - moveDir * followDistance + Vector3.new(0, heightOffset, 0)
                local newPos = Camera.CFrame.Position:Lerp(desiredPos, dt * smoothness)
                local targetLook = CFrame.new(newPos, targetPos)
                Camera.CFrame = Camera.CFrame:Lerp(targetLook, dt * smoothness)
            else
                occlusionTimer = occlusionTimer + dt
                if occlusionTimer < occlusionDelay and lastVisiblePos then
                    local desiredPos = lastVisiblePos + Vector3.new(0,heightOffset,0) - (root.CFrame.LookVector * followDistance)
                    local newPos = Camera.CFrame.Position:Lerp(desiredPos, dt*smoothness)
                    local targetLook = CFrame.new(newPos, lastVisiblePos + Vector3.new(0,2,0))
                    Camera.CFrame = Camera.CFrame:Lerp(targetLook, dt*smoothness)
                else
                    if lastVisiblePos then
                        local targetLook = CFrame.new(Camera.CFrame.Position, lastVisiblePos + Vector3.new(0,2,0))
                        Camera.CFrame = Camera.CFrame:Lerp(targetLook, dt*smoothness)
                    end
                end
            end
        end
    end
end)


--== Auto Rejoin ==--
local autoRejoin=false
local ARBtn=Instance.new("TextButton",Cn)
ARBtn.Size=UDim2.new(1,-40,0,30)
ARBtn.Position=UDim2.new(0,20,0,90)
ARBtn.Text="AutoRejoin: OFF"
ARBtn.BackgroundColor3=Color3.fromRGB(60,60,60)
ARBtn.TextColor3=Color3.new(1,1,1)
ARBtn.BorderSizePixel=0
ARBtn.MouseButton1Click:Connect(function()
	autoRejoin = not autoRejoin
	ARBtn.Text = autoRejoin and "AutoRejoin: ON" or "AutoRejoin: OFF"
	ajustarScroll()
	if autoRejoin then
		task.defer(function()
			task.wait(2)
			pcall(function() TS:Teleport(game.PlaceId,P) end)
		end)
	end
end)

--== Mover y redimensionar ventana ==--
local drag, dragStart, startPos=false
B.InputBegan:Connect(function(i)
	if i.UserInputType==Enum.UserInputType.MouseButton1 then
		drag=true
		dragStart=i.Position
		startPos=W.Position
	end
end)
B.InputEnded:Connect(function(i)
	if i.UserInputType==Enum.UserInputType.MouseButton1 then drag=false end
end)
UIS.InputChanged:Connect(function(i)
	if i.UserInputType==Enum.UserInputType.MouseMovement and drag then
		local d=i.Position - dragStart
		W.Position = UDim2.new(startPos.X.Scale,startPos.X.Offset+d.X,startPos.Y.Scale,startPos.Y.Offset+d.Y)
	end
end)

local resizeBtn=Instance.new("Frame",W)
resizeBtn.Size=UDim2.new(0,20,0,20)
resizeBtn.Position=UDim2.new(1,-20,1,-20)
resizeBtn.BackgroundColor3=Color3.fromRGB(80,80,80)
resizeBtn.Active=true
local resizing=false
resizeBtn.InputBegan:Connect(function(i)
	if i.UserInputType==Enum.UserInputType.MouseButton1 then resizing=true end
end)
UIS.InputEnded:Connect(function(i)
	if i.UserInputType==Enum.UserInputType.MouseButton1 then resizing=false end
end)
UIS.InputChanged:Connect(function(i)
	if i.UserInputType==Enum.UserInputType.MouseMovement and resizing then
		local p=i.Position-W.AbsolutePosition
		W.Size=UDim2.new(0,math.clamp(p.X,200,600),0,math.clamp(p.Y,200,600))
	end
end)

ajustarScroll()
