--== referencias ==
local P = game.Players.LocalPlayer
local Plrs = game:GetService("Players")
local RS = game:GetService("RunService")
local UIS = game:GetService("UserInputService")
local TS = game:GetService("TeleportService")
local Camera = workspace.CurrentCamera

--== personaje ==
local C = P.Character or P.CharacterAdded:Wait()
P.CharacterAdded:Connect(function(char) C = char end)

--== GUI principal ==
local G = Instance.new("ScreenGui", P:WaitForChild("PlayerGui"))
G.Name = "ArsenalGui"

local W = Instance.new("Frame", G)
W.Size = UDim2.new(0,400,0,420)
W.Position = UDim2.new(0.5,-200,0.5,-210)
W.BackgroundColor3 = Color3.fromRGB(20,20,20)
W.Active = true

--== barra superior ==
local B = Instance.new("Frame", W)
B.Size = UDim2.new(1,0,0,30)
B.BackgroundColor3 = Color3.fromRGB(40,40,40)

local T = Instance.new("TextLabel", B)
T.Size = UDim2.new(1,-60,1,0)
T.Text = "Arsenal Control"
T.TextColor3 = Color3.new(1,1,1)
T.BackgroundTransparency = 1
T.TextXAlignment = Enum.TextXAlignment.Left
T.TextSize = 16

--== botón cerrar ==
local CBtn = Instance.new("TextButton", B)
CBtn.Size = UDim2.new(0,30,0,30)
CBtn.Position = UDim2.new(1,-30,0,0)
CBtn.Text = "X"
CBtn.TextScaled = true
CBtn.BackgroundColor3 = Color3.fromRGB(60,60,60)
CBtn.TextColor3 = Color3.new(1,1,1)
CBtn.BorderSizePixel = 0
CBtn.MouseButton1Click:Connect(function() G:Destroy() end)

--== botón minimizar ==
local MinBtn = Instance.new("TextButton", B)
MinBtn.Size = UDim2.new(0,30,0,30)
MinBtn.Position = UDim2.new(1,-60,0,0)
MinBtn.Text = "_"
MinBtn.TextScaled = true
MinBtn.BackgroundColor3 = Color3.fromRGB(60,60,60)
MinBtn.TextColor3 = Color3.new(1,1,1)
MinBtn.BorderSizePixel = 0

local isMinimized = false
local originalSize = W.Size
MinBtn.MouseButton1Click:Connect(function()
	if isMinimized then
		-- Restaurar tamaño
		W.Size = originalSize
		for _, child in pairs(W:GetChildren()) do
			if child ~= B then
				child.Visible = true
			end
		end
	else
		-- Minimizar solo a la barra
		W.Size = UDim2.new(originalSize.X.Scale, originalSize.X.Offset, 0, 30)
		for _, child in pairs(W:GetChildren()) do
			if child ~= B then
				child.Visible = false
			end
		end
	end
	isMinimized = not isMinimized
end)

--== panel lateral (menú) ==
local menuPanel = Instance.new("Frame", W)
menuPanel.Size = UDim2.new(0,120,1,-30)
menuPanel.Position = UDim2.new(0,0,0,30)
menuPanel.BackgroundColor3 = Color3.fromRGB(35,35,35)

local function createMenuButton(name, posY)
	local btn = Instance.new("TextButton", menuPanel)
	btn.Size = UDim2.new(1,0,0,40)
	btn.Position = UDim2.new(0,0,0,posY)
	btn.Text = name
	btn.TextColor3 = Color3.new(1,1,1)
	btn.BackgroundColor3 = Color3.fromRGB(50,50,50)
	btn.BorderSizePixel = 0
	btn.TextSize = 14
	return btn
end

local optionsBtn = createMenuButton("Opciones", 0)
local assignBtn = createMenuButton("Asignar Teclas", 50)

--== panel derecho (contenido) ==
local contentPanel = Instance.new("Frame", W)
contentPanel.Size = UDim2.new(1,-120,1,-30)
contentPanel.Position = UDim2.new(0,120,0,30)
contentPanel.BackgroundColor3 = Color3.fromRGB(25,25,25)

local function showPanel(panel)
	for _,v in pairs(contentPanel:GetChildren()) do
		if v:IsA("Frame") then
			v.Visible = false
		end
	end
	panel.Visible = true
end

--== Opciones Panel ==
local optionsPanel = Instance.new("Frame", contentPanel)
optionsPanel.Size = UDim2.new(1,0,1,0)
optionsPanel.BackgroundTransparency = 1

local ESP = false
local camFollow = false
local autoRejoin = false
local espObjs = {}

local function isEnemy(plr)
	return plr ~= P and plr.Team ~= P.Team
end

local function applyESP(p)
	if espObjs[p] then return end
	if not p.Character then return end
	local hum = p.Character:FindFirstChild("Humanoid")
	if not hum then return end
	local h = Instance.new("Highlight")
	h.Name = "ESP"
	h.FillTransparency = 1
	h.OutlineColor = isEnemy(p) and Color3.fromRGB(255,0,0) or Color3.fromRGB(0,120,255)
	h.OutlineTransparency = 0
	h.Adornee = p.Character
	h.Parent = p.Character
	espObjs[p] = h
end

local function removeESP(p)
	if espObjs[p] then
		espObjs[p]:Destroy()
		espObjs[p] = nil
	end
end

local function toggleESP(state)
	ESP = state
	for _,plr in pairs(Plrs:GetPlayers()) do
		if ESP then applyESP(plr) else removeESP(plr) end
	end
end

local ESPBtn = Instance.new("TextButton", optionsPanel)
ESPBtn.Size = UDim2.new(1,-40,0,30)
ESPBtn.Position = UDim2.new(0,20,0,20)
ESPBtn.Text = "ESP: OFF"
ESPBtn.BackgroundColor3 = Color3.fromRGB(60,60,60)
ESPBtn.TextColor3 = Color3.new(1,1,1)
ESPBtn.BorderSizePixel = 0
ESPBtn.MouseButton1Click:Connect(function()
	ESP = not ESP
	ESPBtn.Text = ESP and "ESP: ON" or "ESP: OFF"
	toggleESP(ESP)
end)

local CamBtn = Instance.new("TextButton", optionsPanel)
CamBtn.Size = UDim2.new(1,-40,0,30)
CamBtn.Position = UDim2.new(0,20,0,60)
CamBtn.Text = "Camara F1: OFF"
CamBtn.BackgroundColor3 = Color3.fromRGB(60,60,60)
CamBtn.TextColor3 = Color3.new(1,1,1)
CamBtn.BorderSizePixel = 0
CamBtn.MouseButton1Click:Connect(function()
	camFollow = not camFollow
	CamBtn.Text = camFollow and "Camara F1: ON" or "Camara F1: OFF"
end)

local ARBtn = Instance.new("TextButton", optionsPanel)
ARBtn.Size = UDim2.new(1,-40,0,30)
ARBtn.Position = UDim2.new(0,20,0,100)
ARBtn.Text = "AutoRejoin: OFF"
ARBtn.BackgroundColor3 = Color3.fromRGB(60,60,60)
ARBtn.TextColor3 = Color3.new(1,1,1)
ARBtn.BorderSizePixel = 0
ARBtn.MouseButton1Click:Connect(function()
	autoRejoin = not autoRejoin
	ARBtn.Text = autoRejoin and "AutoRejoin: ON" or "AutoRejoin: OFF"
	if autoRejoin then
		task.defer(function()
			task.wait(2)
			pcall(function() TS:Teleport(game.PlaceId,P) end)
		end)
	end
end)

--== Asignar Teclas Panel ==
local keybindPanel = Instance.new("Frame", contentPanel)
keybindPanel.Size = UDim2.new(1,0,1,0)
keybindPanel.BackgroundTransparency = 1
keybindPanel.Visible = false

local Keybinds = {
	CamaraF1 = Enum.KeyCode.R,
	ESP = Enum.KeyCode.T,
}

local function createKeybindUI(labelText, defaultKey, posY)
	local lbl = Instance.new("TextLabel", keybindPanel)
	lbl.Size = UDim2.new(0.5,0,0,20)
	lbl.Position = UDim2.new(0,10,0,posY)
	lbl.Text = labelText
	lbl.TextColor3 = Color3.new(1,1,1)
	lbl.BackgroundTransparency = 1
	lbl.TextXAlignment = Enum.TextXAlignment.Left
	lbl.TextSize = 14

	local box = Instance.new("TextBox", keybindPanel)
	box.Size = UDim2.new(0.4,-10,0,20)
	box.Position = UDim2.new(0.55,0,0,posY)
	box.Text = defaultKey.Name
	box.ClearTextOnFocus = false
	box.TextColor3 = Color3.new(0,0,0)
	box.BackgroundColor3 = Color3.fromRGB(200,200,200)
	box.TextSize = 14
	return box
end

local CamKeyBox = createKeybindUI("Cámara F1:", Keybinds.CamaraF1, 30)
local ESPKeyBox = createKeybindUI("ESP:", Keybinds.ESP, 70)

CamKeyBox.FocusLost:Connect(function()
	local key = CamKeyBox.Text:upper()
	local success, enumKey = pcall(function() return Enum.KeyCode[key] end)
	if success and enumKey then Keybinds.CamaraF1 = enumKey else CamKeyBox.Text = Keybinds.CamaraF1.Name end
end)

ESPKeyBox.FocusLost:Connect(function()
	local key = ESPKeyBox.Text:upper()
	local success, enumKey = pcall(function() return Enum.KeyCode[key] end)
	if success and enumKey then Keybinds.ESP = enumKey else ESPKeyBox.Text = Keybinds.ESP.Name end
end)

--== cambiar panel según menú ==
optionsBtn.MouseButton1Click:Connect(function() showPanel(optionsPanel) end)
assignBtn.MouseButton1Click:Connect(function() showPanel(keybindPanel) end)

--== mover ventana ==
local drag, dragStart, startPos = false
B.InputBegan:Connect(function(i)
	if i.UserInputType == Enum.UserInputType.MouseButton1 then
		drag = true
		dragStart = i.Position
		startPos = W.Position
	end
end)
B.InputEnded:Connect(function(i)
	if i.UserInputType == Enum.UserInputType.MouseButton1 then drag = false end
end)
UIS.InputChanged:Connect(function(i)
	if i.UserInputType == Enum.UserInputType.MouseMovement and drag then
		local d = i.Position - dragStart
		W.Position = UDim2.new(startPos.X.Scale,startPos.X.Offset + d.X, startPos.Y.Scale, startPos.Y.Offset + d.Y)
	end
end)

--== Hotkeys ==
UIS.InputBegan:Connect(function(input, gpe)
	if gpe then return end
	if input.KeyCode == Keybinds.ESP then
		ESP = not ESP
		ESPBtn.Text = ESP and "ESP: ON" or "ESP: OFF"
		toggleESP(ESP)
	elseif input.KeyCode == Keybinds.CamaraF1 then
		camFollow = not camFollow
		CamBtn.Text = camFollow and "Camara F1: ON" or "Camara F1: OFF"
	end
end)

--== Actualizar ESP dinámicamente ==
Plrs.PlayerAdded:Connect(function(plr)
	plr.CharacterAdded:Connect(function()
		if ESP then applyESP(plr) end
	end)
end)

--== Camera Follow ==
RS.RenderStepped:Connect(function()
	if camFollow then
		local target
		for _,plr in pairs(Plrs:GetPlayers()) do
			if isEnemy(plr) and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
				target = plr.Character.HumanoidRootPart
				break
			end
		end
		if target then
			Camera.CFrame = CFrame.new(Camera.CFrame.Position, target.Position)
		end
	end
end)
